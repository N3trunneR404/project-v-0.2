$schema: "https://json-schema.org/draft/2020-12/schema"
$title: "Fabric Topology Schema"
$type: object
$comment: >
  Validates topology.yaml describing network/fabric characteristics, link models, and experiment scenarios.
  Node names referenced here should correspond to files in ./nodes/, but cross-file existence is not validated by this schema.

required: [version, metadata, defaults, regions, links, scenarios]
properties:

  version:
    type: string
    pattern: "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    description: Schema/descriptor version (e.g., 0.1.0)

  metadata:
    type: object
    required: [name, owner]
    properties:
      name: { type: string }
      owner: { type: string }
      description: { type: string }
      created: { type: string, format: date-time }
      tags:
        type: array
        items: { type: string }

  defaults:
    type: object
    description: Global defaults applied unless overridden at region/site/link level.
    properties:
      network:
        type: object
        properties:
          fabric: { enum: [ethernet, infiniband, wifi, lte, satellite] }
          speed_gbps: { type: number, minimum: 0 }
          rtt_ms: { type: number, minimum: 0 }
          jitter_ms: { type: number, minimum: 0 }
          loss_pct: { type: number, minimum: 0, maximum: 100 }
          ecn: { type: boolean }
          mtu_bytes: { type: integer, minimum: 128 }
          rocev2: { type: boolean }
      routing:
        type: object
        properties:
          domain: { enum: [lan, wan, campus, metro, internet] }
          qos_classes:
            type: array
            items:
              type: object
              required: [name, priority]
              properties:
                name: { type: string }
                priority: { type: integer, minimum: 0, maximum: 7 }
                bandwidth_floor_mbps: { type: number, minimum: 0 }
                latency_target_ms: { type: number, minimum: 0 }
      security:
        type: object
        properties:
          tls_offload_allowed: { type: boolean }
          ipsec_allowed: { type: boolean }
          zero_trust:
            type: object
            properties:
              enabled: { type: boolean }
              policy: { type: string }
      pricing:
        type: object
        properties:
          currency: { type: string }
          cpu_core_hour: { type: number, minimum: 0 }
          gpu_hour: { type: number, minimum: 0 }
          npu_hour: { type: number, minimum: 0 }
          memory_gb_hour: { type: number, minimum: 0 }
          storage_gb_month: { type: number, minimum: 0 }
          egress_gb: { type: number, minimum: 0 }
      energy:
        type: object
        properties:
          grid_co2_g_per_kwh: { type: number, minimum: 0 }
          price_per_kwh: { type: number, minimum: 0 }

  regions:
    type: array
    minItems: 1
    description: Logical geography. Each region may contain multiple sites.
    items:
      type: object
      required: [name, sites]
      properties:
        name: { type: string }
        labels:
          type: object
          additionalProperties: { type: string }
        network:
          type: object
          description: Region-level overrides.
          properties:
            fabric: { enum: [ethernet, infiniband, wifi, lte, satellite] }
            speed_gbps: { type: number, minimum: 0 }
            rtt_ms: { type: number, minimum: 0 }
            jitter_ms: { type: number, minimum: 0 }
            loss_pct: { type: number, minimum: 0, maximum: 100 }
            rocev2: { type: boolean }
            mtu_bytes: { type: integer, minimum: 128 }
        sites:
          type: array
          minItems: 1
          items:
            type: object
            required: [name]
            properties:
              name: { type: string }
              cidr: { type: string }
              labels:
                type: object
                additionalProperties: { type: string }
              network:
                type: object
                properties:
                  fabric: { enum: [ethernet, infiniband, wifi, lte, satellite] }
                  speed_gbps: { type: number, minimum: 0 }
                  rtt_ms: { type: number, minimum: 0 }
                  jitter_ms: { type: number, minimum: 0 }
                  loss_pct: { type: number, minimum: 0, maximum: 100 }
                  rocev2: { type: boolean }
                  mtu_bytes: { type: integer, minimum: 128 }
              dpus:
                type: array
                description: Site-level DPU/SmartNIC capabilities available for offload.
                items:
                  type: object
                  required: [type, ports_gbps]
                  properties:
                    type: { enum: [bluefield3, pensando_elba, intel_ipu_e2100, other] }
                    ports_gbps: { type: integer, minimum: 1 }
                    protocol: { enum: [rocev2, infiniband, tcp] }
                    offloads:
                      type: array
                      items: { enum: [tls, ipsec, nvmeof, vxlan, geneve, compression, telemetry] }

  subnets:
    type: array
    description: Optional explicit L3 subnets used by links/nodes.
    items:
      type: object
      required: [name, cidr]
      properties:
        name: { type: string }
        cidr: { type: string }
        site: { type: string }
        qos_class: { type: string }

  link_profiles:
    type: array
    description: Reusable link templates you can reference in links[].profile.
    items:
      type: object
      required: [name, speed_gbps, rtt_ms]
      properties:
        name: { type: string }
        fabric: { enum: [ethernet, infiniband, wifi, lte, satellite] }
        speed_gbps: { type: number, minimum: 0 }
        rtt_ms: { type: number, minimum: 0 }
        jitter_ms: { type: number, minimum: 0 }
        loss_pct: { type: number, minimum: 0, maximum: 100 }
        ecn: { type: boolean }
        mtu_bytes: { type: integer, minimum: 128 }

  links:
    type: array
    minItems: 1
    description: Point-to-point or logical links between nodes or sites.
    items:
      type: object
      required: [a, b]
      properties:
        a: { type: string, description: "endpoint A (node or site name)" }
        b: { type: string, description: "endpoint B (node or site name)" }
        scope: { enum: [node, site, region, internet], default: node }
        profile: { type: string, description: "optional link_profiles name" }
        fabric: { enum: [ethernet, infiniband, wifi, lte, satellite] }
        speed_gbps: { type: number, minimum: 0 }
        rtt_ms: { type: number, minimum: 0 }
        jitter_ms: { type: number, minimum: 0 }
        loss_pct: { type: number, minimum: 0, maximum: 100 }
        ecn: { type: boolean }
        mtu_bytes: { type: integer, minimum: 128 }
        rocev2: { type: boolean }
        qos_class: { type: string }
        subnet: { type: string }
        constraints:
          type: object
          properties:
            allow_formats:
              type: array
              items: { enum: [native, wasm, cuda, npu, fpga, asic] }
            disallow_large_payload_mb: { type: number, minimum: 0 }
            max_concurrent_flows: { type: integer, minimum: 1 }

  placement_policies:
    type: object
    description: Global policy hints for the scheduler/DT.
    properties:
      prefer_same_site: { type: boolean }
      prefer_same_region: { type: boolean }
      prefer_low_co2: { type: boolean }
      max_replication_factor: { type: integer, minimum: 1 }
      spill_to_cxl_allowed: { type: boolean }
      format_preferences:
        type: array
        items:
          type: object
          required: [stage_type, order]
          properties:
            stage_type: { type: string }
            order:
              type: array
              items: { enum: [cuda, npu, fpga, native, wasm, asic] }

  data_locality:
    type: array
    description: Where specific datasets “live”; helps DT minimize egress.
    items:
      type: object
      required: [dataset, at]
      properties:
        dataset: { type: string }
        at:
          type: array
          items: { type: string, description: "node or site name" }
        size_gb: { type: number, minimum: 0 }
        cold_to_hot_ms: { type: number, minimum: 0, description: "warmup time to cache/activate" }

  trust_overrides:
    type: array
    description: Optional trust scores for nodes/sites during a scenario.
    items:
      type: object
      required: [target, trust]
      properties:
        target: { type: string }   # node or site
        trust: { type: number, minimum: 0, maximum: 1 }
        note: { type: string }

  chaos:
    type: array
    description: Time-based fault injections.
    items:
      type: object
      required: [kind, at_s]
      properties:
        kind:
          enum: [
            link_degrade, link_loss_spike, link_down, link_up,
            node_kill, node_recover, power_cap, thermal_derate,
            clock_skew, packet_dup, packet_reorder
          ]
        at_s: { type: number, minimum: 0 }
        duration_s: { type: number, minimum: 0 }
        a: { type: string }          # endpoint A (for link events)
        b: { type: string }          # endpoint B (for link events)
        node: { type: string }       # node name (for node events)
        speed_gbps: { type: number, minimum: 0 }
        rtt_ms: { type: number, minimum: 0 }
        jitter_ms: { type: number, minimum: 0 }
        loss_pct: { type: number, minimum: 0, maximum: 100 }
        power_cap_w: { type: number, minimum: 0 }
        thermal_derate: { type: number, minimum: 0, maximum: 1 }
        skew_ms: { type: number }    # for clock_skew

  scenarios:
    type: array
    minItems: 1
    description: Named experiment bundles (which chaos, which policies).
    items:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string }
        apply:
          type: object
          properties:
            placement_policies: { $ref: "#/properties/placement_policies" }
            trust_overrides:
              type: array
              items: { $ref: "#/properties/trust_overrides/items" }
            data_locality:
              type: array
              items: { $ref: "#/properties/data_locality/items" }
            link_overrides:
              type: array
              items:
                type: object
                required: [a, b]
                properties:
                  a: { type: string }
                  b: { type: string }
                  speed_gbps: { type: number, minimum: 0 }
                  rtt_ms: { type: number, minimum: 0 }
                  jitter_ms: { type: number, minimum: 0 }
                  loss_pct: { type: number, minimum: 0, maximum: 100 }
        chaos:
          type: array
          items: { $ref: "#/properties/chaos/items" }

additionalProperties: false

