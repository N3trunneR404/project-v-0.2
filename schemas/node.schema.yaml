$schema: "https://json-schema.org/draft/2020-12/schema"
$title: "Fabric Node Descriptor Schema"
$type: object
$comment: >
  Validates one device descriptor in ./nodes/*.yaml.
  Covers phones/SBCs/workstations/servers/HPC with GPUs/NPUs/FPGAs/ASICs/DPUs/CXL.

required:
  - name
  - class
  - arch
  - role
  - cpu
  - memory
  - storage
  - network
  - labels
  - health
  - formats_supported

properties:

  # Identity & classification
  name: { type: string, pattern: "^[a-zA-Z0-9._:-]+$" }
  class: { enum: [phone, sbc, laptop, workstation, gaming_rig, server, hpc] }
  role:  { enum: [worker, manager, gateway, storage, accelerator] }
  arch:  { enum: [amd64, arm64, riscv64] }

  os:
    type: object
    properties:
      distro: { type: string }
      version: { type: string }
      kernel: { type: string }
      container_runtime: { enum: [docker, containerd, podman], nullable: true }

  power:
    type: object
    properties:
      supply_w: { type: number, minimum: 0 }
      poe: { type: boolean }
      battery_present: { type: boolean }
      tdp_total_w: { type: number, minimum: 0 }

  # CPU / memory
  cpu:
    type: object
    required: [cores, base_ghz, turbo_ghz, tdp_w]
    properties:
      uarch: { type: string }           # e.g., Zen4, Neoverse V1
      isa_ext:                           # SIMD/crypto hints (for format choice)
        type: array
        items: { enum: [avx2, avx512, sse4_2, neon, sve, sve2, sha, aes] }
      cores: { type: integer, minimum: 1 }
      base_ghz: { type: number, minimum: 0.1 }
      turbo_ghz: { type: number, minimum: 0.1 }
      tdp_w: { type: number, minimum: 0 }
      numa_nodes: { type: integer, minimum: 1, default: 1 }

  memory:
    type: object
    required: [ram_gb]
    properties:
      ram_gb: { type: number, minimum: 0.5 }
      ecc: { type: boolean, default: false }
      channels: { type: integer, minimum: 1 }
      ddr_gen: { enum: [ddr4, ddr5, lpddr4, lpddr5], nullable: true }

  # Storage & endurance
  storage:
    type: object
    required: [type, size_gb]
    properties:
      type: { enum: [nvme, sata, zns, emmc, microsd] }
      interface_gen: { enum: [pcie3, pcie4, pcie5], nullable: true }
      size_gb: { type: number, minimum: 1 }
      tbw_pct_used: { type: number, minimum: 0, maximum: 100, default: 0 }
      smart_health: { type: number, minimum: 0, maximum: 1, default: 1 }
      qd_cap: { type: integer, minimum: 1 }  # queue-depth cap (approx)

  # Battery (phones/laptops)
  battery:
    type: object
    properties:
      present: { type: boolean, default: false }
      level_pct: { type: number, minimum: 0, maximum: 100 }
      cycles: { type: integer, minimum: 0 }
      health_pct: { type: number, minimum: 0, maximum: 100 }

  # GPUs (discrete or integrated)
  gpu:
    type: object
    properties:
      type:   { enum: [none, mock, real], default: none }
      vendor: { enum: [nvidia, amd, apple, intel, none], default: none }
      model:  { type: string }
      vram_gb: { type: number, minimum: 0 }
      cuda_cores: { type: integer, minimum: 0 }
      tensor_cores: { type: integer, minimum: 0 }
      rt_cores: { type: integer, minimum: 0 }
      compute_capability: { type: string }  # e.g., "9.0" for H100
      hbm_gb: { type: number, minimum: 0 }
      hbm_bw_tbps: { type: number, minimum: 0 }
      nvlink: { type: boolean }
      tdp_w: { type: number, minimum: 0 }
      accel_score: { type: number, minimum: 0 }  # normalized speed hint (sim)

  # Other accelerators (per-node grab-bag)
  accelerators:
    type: object
    properties:
      # Edge NPUs
      npu: { enum: [none, coral_usb, ncs2, ascend, other], default: none }
      npu_tops: { type: number, minimum: 0, default: 0 }
      jetson_cuda: { type: boolean, default: false }

      # FPGAs
      fpga_card: { enum: [none, alveo_u55c, agilex7, other], default: none }
      fpga_hbm_gb: { type: number, minimum: 0 }
      fpga_net_gbps: { type: number, minimum: 0 }
      fpga_bitstream: { type: string }
      fpga_toolchain: { type: string }

      # Cloud/AI ASICs (simulated)
      asic_kind: { enum: [none, tpu_v4, inferentia2, trainium, gaudi2, other], default: none }
      asic_memory_gb: { type: number, minimum: 0 }
      asic_interconnect: { enum: [none, tpu_torus, neuronlink, rocev2], default: none }
      asic_dtypes:
        type: array
        items: { enum: [fp32, bf16, fp16, fp8, int8, int4] }

  # DPU / SmartNIC offloads
  dpu:
    type: object
    properties:
      type: { enum: [none, bluefield3, pensando_elba, intel_ipu_e2100, other], default: none }
      ports_gbps: { type: integer, minimum: 0 }
      protocol: { enum: [rocev2, infiniband, tcp], nullable: true }
      offloads:
        type: array
        items: { enum: [tls, ipsec, nvmeof, vxlan, geneve, compression, telemetry] }

  # CXL memory expansion (Type-3)
  cxl:
    type: object
    properties:
      type: { enum: [none, type3_memory], default: none }
      capacity_gb: { type: number, minimum: 0 }
      link_gtps: { type: number, minimum: 0 }   # lane speed proxy
      added_ns_latency: { type: number, minimum: 0 }

  # I/O traits (for SBCs/edge boxes)
  io:
    type: object
    properties:
      has_usb3: { type: boolean }
      csi_cam:  { type: boolean }
      m2_socket: { type: boolean }
      pcie_lanes: { type: integer, minimum: 0 }

  # Network / fabric
  network:
    type: object
    required: [base_latency_ms, base_bandwidth_mbps]
    properties:
      fabric: { enum: [ethernet, infiniband, wifi, lte, satellite], default: ethernet }
      link:   { enum: [ethernet, wifi, lte, other], nullable: true }  # legacy field support
      speed_gbps: { type: number, minimum: 0 }
      base_latency_ms: { type: number, minimum: 0 }
      base_bandwidth_mbps: { type: number, minimum: 0 }
      jitter_ms: { type: number, minimum: 0, default: 0 }
      loss_pct: { type: number, minimum: 0, maximum: 100, default: 0 }
      ecn: { type: boolean, default: false }
      mtu_bytes: { type: integer, minimum: 128 }
      rocev2: { type: boolean, default: false }
      wifi_standard: { enum: [802.11ac, 802.11ax, 802.11be], nullable: true }
      mlo: { type: boolean }  # Wi-Fi 7 Multi-Link Operation

  # Formats & execution support
  formats_supported:
    type: array
    minItems: 1
    items: { enum: [native, wasm, cuda, npu, fpga, asic] }

  # Free-form labels (zone/trust/etc.)
  labels:
    type: object
    properties:
      zone: { type: string }     # e.g., lab, edge, home, cloudlet
      rack: { type: string }
      trust: { type: string }    # store as string; planner will parse float
      wasm: { type: string }     # "enabled"/"disabled"
      owner: { type: string }
    additionalProperties: { type: string }

  # Health & stability (feeds failure risk)
  health:
    type: object
    properties:
      ram_errors_million_hours: { type: number, minimum: 0, default: 0 }
      last_week_crashes: { type: integer, minimum: 0, default: 0 }
      thermal_derate: { type: number, minimum: 0, maximum: 1, default: 0 }
      last_service_days: { type: integer, minimum: 0 }
      temperature_c: { type: number }
      fan_fault: { type: boolean }

  # Optional data location hints (per-node)
  data_locality:
    type: array
    items:
      type: object
      required: [dataset]
      properties:
        dataset: { type: string }
        size_gb: { type: number, minimum: 0 }
        cold_to_hot_ms: { type: number, minimum: 0 }

additionalProperties: false

